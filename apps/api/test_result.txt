
> @kaarplus/api@1.0.0 test
> vitest run src/__tests__/routes/user.test.ts


[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90m/Users/elnuraghabayli/Desktop/Kaarplus/apps/api[39m

[90mstderr[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes
[22m[39m[Stripe] STRIPE_SECRET_KEY is not set. Payments will fail.

[90mstdout[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes
[22m[39m[2026-02-18T09:58:42.966Z] INFO [SocketService] Socket.io server initialized
[2026-02-18T09:58:42.966Z] INFO [App] Socket.io initialized successfully

[90mstderr[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes[2m > [22m[2mFavorites[2m > [22m[2mshould add a favorite
[22m[39m[2026-02-18T09:58:42.974Z] ERROR Unhandled error {"message":"prisma is not defined","stack":"ReferenceError: prisma is not defined\n    at Object.<anonymous> (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/__tests__/setup.ts:63:57)\n    at Object.Mock [as $transaction] (file:///Users/elnuraghabayli/Desktop/Kaarplus/node_modules/@vitest/spy/dist/index.js:285:34)\n    at Object.addFavorite (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/services/favoriteService.ts:55:39)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at addFavorite (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/controllers/favoriteController.ts:36:26)"}

[90mstderr[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes[2m > [22m[2mFavorites[2m > [22m[2mshould add a favorite
[22m[39mPOST /api/user/favorites failed: { error: [32m'prisma is not defined'[39m, code: [32m'INTERNAL_ERROR'[39m }

[90mstderr[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes[2m > [22m[2mFavorites[2m > [22m[2mshould remove a favorite
[22m[39m[2026-02-18T09:58:42.980Z] ERROR Unhandled error {"message":"prisma is not defined","stack":"ReferenceError: prisma is not defined\n    at Object.<anonymous> (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/__tests__/setup.ts:63:57)\n    at Object.Mock [as $transaction] (file:///Users/elnuraghabayli/Desktop/Kaarplus/node_modules/@vitest/spy/dist/index.js:285:34)\n    at Object.removeFavorite (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/services/favoriteService.ts:84:22)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at removeFavorite (/Users/elnuraghabayli/Desktop/Kaarplus/apps/api/src/controllers/favoriteController.ts:63:9)"}

[90mstderr[2m | src/__tests__/routes/user.test.ts[2m > [22m[2mUser Routes[2m > [22m[2mFavorites[2m > [22m[2mshould remove a favorite
[22m[39mDELETE /api/user/favorites failed: { error: [32m'prisma is not defined'[39m, code: [32m'INTERNAL_ERROR'[39m }

 [31mâ¯[39m src/__tests__/routes/user.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 432[2mms[22m[39m
[31m       [31mÃ—[31m should return user favorites[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should add a favorite[39m[32m 10[2mms[22m[39m
[31m       [31mÃ—[31m should remove a favorite[39m[32m 3[2mms[22m[39m
       [32mâœ“[39m should return conversations[32m 3[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 3 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m src/__tests__/routes/user.test.ts[2m > [22mUser Routes[2m > [22mFavorites[2m > [22mshould return user favorites
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'mockResolvedValue')[39m
[36m [2mâ¯[22m src/__tests__/routes/user.test.ts:[2m36:44[22m[39m
    [90m 34| [39m            (prisma.favorite.findMany as any).mockResolvedValue(mockFaâ€¦
    [90m 35| [39m            (prisma.favorite.findMany as any).mockResolvedValue(mockFaâ€¦
    [90m 36| [39m            (prisma[33m.[39mfavorite[33m.[39mcount [35mas[39m any)[33m.[39m[34mmockResolvedValue[39m([34m1[39m)[33m;[39m
    [90m   | [39m                                           [31m^[39m
    [90m 37| [39m
    [90m 38| [39m            [35mconst[39m response [33m=[39m [35mawait[39m [34mrequest[39m(app)

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/routes/user.test.ts[2m > [22mUser Routes[2m > [22mFavorites[2m > [22mshould add a favorite
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/__tests__/routes/user.test.ts:[2m63:37[22m[39m
    [90m 61| [39m            }
    [90m 62| [39m
    [90m 63| [39m            [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m 64| [39m            [34mexpect[39m(prisma[33m.[39mfavorite[33m.[39mcreate)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m 65| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯[22m[39m

[41m[1m FAIL [22m[49m src/__tests__/routes/user.test.ts[2m > [22mUser Routes[2m > [22mFavorites[2m > [22mshould remove a favorite
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m src/__tests__/routes/user.test.ts:[2m83:37[22m[39m
    [90m 81| [39m            }
    [90m 82| [39m
    [90m 83| [39m            [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m 84| [39m            [34mexpect[39m(prisma[33m.[39mfavorite[33m.[39m[35mdelete[39m)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m 85| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (4)[39m
[2m   Start at [22m 11:58:42
[2m   Duration [22m 549ms[2m (transform 191ms, setup 21ms, import 43ms, tests 432ms, environment 0ms)[22m

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Users/elnuraghabayli/Desktop/Kaarplus/apps/api
npm error workspace @kaarplus/api@1.0.0
npm error location /Users/elnuraghabayli/Desktop/Kaarplus/apps/api
npm error command failed
npm error command sh -c vitest run src/__tests__/routes/user.test.ts
